## 运输层协议概述

#### 进程之间的通信

​	从通信和信息处理的角度看，**运输层向它上面的应用层提供通信服务**。
​	真正进行通信的实体是一台主机中的**应用进程**和另一台主机中的**应用进程**在数据交换。通信的的两端应当是**两个主机中的应用进程**，端到端的通信是**应用进程之间的通信**。

​	运输层的一个很重要的功能是：**分用** 和 **复用**
​		**复用** 是指在发送方的不同应用进程都可以使用同一个运输层协议传送数据(加上适当的首部)。
​		**分用** 是指接收方的运输层在剥去报文的首部后能够把这些数据正确交付目的应用进程。
​	运输层提供应用进程的**逻辑通信**。

​	网络层和运输层的**区别**：网络层为**主机之间的通信**提供服务，而运输层则在网络层的基础上，为**应用进程之间**的通信提供服务。
​	运输层还要对收到的报文进行**差错检测**。运输层向高层用户**屏蔽了下面网络核心的细节**。
​	**TCP协议**，尽管下面的网络不可靠，但这种逻辑通信信道就相当于一条**全双工的可靠信道**。而**UDP**协议，仍然是一条不可靠信道。

#### 运输层的两个主要协议

​	(1) **用户数据报协议UDP**
​	(2) **传输控制协议TCP**
​	两个对等运输实体在通信时传送的数据单位叫做**运输协议数据单元TPDU**。TCP中的叫**TCP报文段**，UDP中的叫**UDP用户数据报**。
​	**基于TCP的应用层协议有**：**HTTP**、**FTP**、**SMTP**、**TELNET**：远程终端协议、SSH
​	**基于UDP的应用层协议**：**DNS**、**TFTP**（简单文件传输协议）、**SNMP**：简单网络管理协议、**RIP**、**DHCP**：动态主机配置协议、NFS、IP电话、IGMP(网际组管理协议)

#### 运输层端口号：

​	为了保证能够**发送数据到正确的应用进程**，我们通过**协议端口**来实现。在**协议栈层间的抽象的协议端口**是**软件端口**，是应用层的各种**协议进程与运输实体进行层间交互的地点**。
​	应用层要发送数据时，应用进程就把**数据发送到合适的端口**，运输层从该**端口读取数据**；运输层收到对方主机发来的数据时，就把**数据发送到适当的端口**，然后**应用进程**就从该**端口读取这些数据**。
​	(1) **服务器端**使用的端口号
​		分两类，一种叫做**熟知端口号**或**全球通用端口号**，数值为1~1023； 另一类叫做**登记端端口号**，数值为1024~49151。
​	

| 应用程序   | FTP  | TELNET | SMTP | DNS  | TFTP | HTTP | SNMP | SNMP | HTTPS |
| ---------- | :--: | :----: | ---- | ---- | ---- | ---- | ---- | ---- | :---: |
| 熟知端口号 |  21  |   23   | 25   | 53   | 69   | 80   | 161  | 162  |  443  |

​	(2) **客户端**使用的端口号
​		数值为49152~65535，又叫**短暂端口号**。

## 用户数据报协议UDP

#### UDP概述

​	用户数据报协议UDP只在**IP的数据报服务之上增加了很少一点的功能**，这就是**复用**和**分用**的功能以及**差错检测**的功能。
​	==主要特点：==
​		(1) 面向**无连接的**(2) **尽最大努力交付**(3) **面向报文**(4) **没有拥塞控制**(5) UDP**支持一对一、一对多、多对一、多对多的交互通信**(6) **首部开销小，只有8个字节**

#### ==UDP首部格式== 4个
​	由四个字段组成，每个字段的长度都是2字节：(1)**源端口**(2)**目的端口**(3)**长度**：最小是8只有首部(4)**检验和**：计算式需要加上12字节的伪首部，并且将首部和数据部分一起都检验(**会补齐偶数字节**)。
​	采用的方法是：**反码运算求和**，**再将结果求反码**。
​	伪首部：源IP地址：4字节，目的IP地址：4字节，待定：1字节，协议号：1字节，UDP长度：2字节
补充：udp实现可靠传输

（1）ACK机制
（2）重传机制
（3）序号机制
（4）重排机制
（5）窗口机制

## 传输控制协议TCP

#### ==TCP最主要的特点==
​	(1) TCP是**面向连接的运输层协议**(2) TCP提供**可靠交付的服务**(3) TCP提供**全双工通信**(4) TCP连接**只能是点对点**的(5)**面向字节流**：流指的是流入到进程或从进程流出的字节序列，TCP并不知道这个字节流的含义。(6)首部开销较大**最小长度是20字节**

#### TCP的连接

​	TCP把**连接**作为**最基本的抽象**。 每一条连接有两个端点，TCP连接的断点叫做**套接字socket**或**插口**。**端口号拼接到IP地址**即构成了**套接字**
​		**套接字socket = (IP地址：端口号)**
​		每一条TCP连接唯一地被通信两端的两个端点(即套接字对socket pair)所确定。即：
​			TCP连接 ::={socket1, socket2} = { (IP1：port1), (IP2：port2) }
​		**同一个IP地址**可以有多个**不同的TCP连接**，而**同一个端口号**也可以出现再多个**不同的TCP连接**中。

## 可靠传输的工作原理

​	(1) 传输信道**不产生差错**。(2) 不管发送方以多块的速度发送数据，接收方总是**来得及处理收到的数据**

#### 停止等待协议

​	每发送完一个分组就停止发送，等待对方的确认。

​	1.无差错情况：发送一次，确认一次。

​	2.出现差错：A**超过一段时间仍然没有收到确认**，就认为发送的**分组丢失了**，因而进行**超时重传**
​		A发送完后，必须**暂时保留已发送的分组的副本**。
​		分组和确认分组都必须进行**编号**。
​		**重传时间**应当比数据在**分组传输的平均往返时间更长一些**。

​	3.确认丢失和确认迟到：
​		**确认丢失**：**丢弃这个重复的分组M1**，**向A发送确认**。
​		**确认迟到**：A收下重复的确认，什么也不做。B丢弃重复的M，并重传确认分组。

​	4.信道利用率：
​		**U = TD / (TD + RTT + TA)**	**TD**发送分组需要的时间，**RTT**往返时间，**TA**发送确认分组需要的时间

#### 连续ARQ协议

​	维持一个**发送窗口**：位于发送窗口内的分组都**可连续发送出去**，而**不需要等待对方的确认**。
​	接收方采用**累计确认**的方式：对按序到达的**最后一个分组发送确认**。
​		优点：容易实现，**确认丢失也不必重传**；
​		缺点：**不能**向发送方**及时反映**接收方已经**正确收到所有分组的信息**。

## ==TCP报文端的首部格式== 16个
​	前**20个字节是固定**的，后面有**4n字节**是根据需要而增加的选项(n是整数)。
​		(1) **源端口**和**目的端口**：各占2字节
​		(2) **序号**：占4字节，每个字节都按顺序编号
​		(3) **确认号**：期望收到对方下一个报文段的第一个数据字节的序号
​		(4) **数据偏移**：占4位，指出TCP报文段的**数据起始处**距离TCP**报文段的起始处**有多远。
​		(5) **保留**：占6位 
​		六个控制位： 紧急URG，确认ACK，推送PSH，复位RST；建立与释放：SYN，FIN
​		(6) **紧急URG**：为1时表明紧急指针字段有效，表明尽快传送紧急数据。配合**紧急指针**使用
​		(7) **确认ACK**：ACK = 1时确认字段有效。
​		(8) **推送PSH**：PSH = 1，表明尽快地交付接收应用数据。
​		(9) **复位RST**：RST = 1时，表明TCP连接中**出现严重差错**，必须释放连接，然后**重新建立运输连接**
​		(10) **同步SYN**：在**连接建立时用来同步序号**。
​		(11) **终止FIN**：用来**释放一个连接**。
​		(12) **窗口**：占2字节，窗口值作为**接收方让发送发设置其发送窗口**的依据。
​		(13) **检验和**：占2字节，检验和字段检验地范围包括首部和数据两个部分，计算时要加上12字节地伪首部
​		(14) **紧急指针**：占2字节，指出本报文段中的**紧急数据的字节数**。指出了紧急数据的末尾在报文段中的位置
​		(15) **选项**：长度可变，最长可达40字节，最初只有一种选项最大报文段长度MSS：数据字段的最大长度。
​		(16) **填充**：保证TCP首部长度时4字节的整数倍。

​		后续有增加了几个选项：
​			**窗口扩大选项**：3字节，一个字节表示移位值S
​			**时间戳选项**：占10字节，包括**时间戳值字段**和**时间戳回送回答字段**，计算往返时间RTT，用于处理TCP序号超过2的32次方的请看，**防止序号绕回PAWS**。
​			**选择确认选项**：TCP可靠传输的实现中介绍

## TCP可靠传输的实现

#### 以字节为单位的滑动窗口

​	描述一个发送窗口的状态需要三个指针：P1， P2， P3。
​		P1之前的数据是**已发送并收到确认的部分**。
​		P1到P2之间是**已发送但未收到确认的部分**，P2到P3是**允许发送但尚未发送的部分**。
​		P3之后的数据是**不允许发送的部分**。

TCP的**发送缓存**和**接收缓存：**
=======

发送缓存：
​	1.发送应用程序传送给发送方TCP准备发送的数据。 
​	2.TCP已发送出但尚未收到确认的数据。
​接收缓存：
​	1.按序到达的，但尚未被接收应用程序读取的数据。 
​	2.未按序到达的数据。

#### 超时重传时间的选择

​	TCP采用了一种自适应算法，他记录一个报文段**发出的时间**，以及收到相应的**确认的时间**。这两个时间纸擦和就是报文段的往返时间RTT。TCP保留了RTT的一个==加权平均往返时间RTTs==
​	**新的RTTs = (1 - α) * (旧的RTTs) + α * (新的RTT样本)** 	α= 0.125
​	超时重传时间RTO = RTTs + 4 * RTTd； RTTd是RTTs的偏差的加权平均值。
​	**新的RTTd = (1 - β) * (旧的RTTd) + β * |RTTs - 新的RTT样本|**    β = 0.25
​	在计算加权平均RTTs时，只要报文段重传了，就不采用其往返时间样本，这样得出的加权平均RTTs和RTO就比较准确。Karn算法修正：**报文段每重传一次，就把==超时重传时间RTO==增大一些**，一般采用乘2。

#### 选择确认SACK

一般一个**字节块需要左右两个边界，一个边界要4个字节**。因此一个TCP报文**最多指明四个缺失的字节块**因为可扩展长度最大为40字节。
在使用SACK的手，还需要在**TCP建立连接的时候**，在**TCP首部的选项中加入允许SACK的选项**。

## TCP的流量控制

#### 利用滑动窗口实现流量控制

​	**流量控制**：就是让==发送方的发送速率不要太快==，==要让接收方来得及接收==。
​	发送方的**发送窗口不能超过**接收方给出的**接收窗口**rwnd。TCP的窗口单位是字节，不是报文段。
​	TCP为每一个连接设有一个持续计时器，TCP连接的一方**收到对方的零窗口通知后**，就**启动持续计时器**。若持续计时器设置的**时间到期**，就**发送一个零窗口探测报文段**(仅携带1字节的数据)，而对方就在**确认这个探测报文段时**，**给出了现在的窗口值**。

#### TCP的传输效率

​	1.使用不**同的机制**来控制**TCP报文段的发送时机。**
​		第一种 TCP维持一个变量等于最大报文段长度，当缓存中存放的数据达到MSS字节时，就发送出去。
​		第二种 使用TCP支持的推送操作。
​		第三种 使用计时器，每次计时器期限到了则将已有的缓存数据发出去。
​	2.Nagle算法：若发送应用进程要把发送的数据逐个字节地送到TCP发送缓存，则发送方就把第一个字节先发送出去，把后面的字节存储起来。当**发送方接收到第一个数据字符确认后**，**再把发送缓存中所有数据组装成一个报文段发送出去**，同时继续对随后到达的数据进行缓存。Nagle算法还规定，当到达地数据以达到发送窗口大小的一半或以达到报文段的最大长度时，就立即发送一个报文段。

​	3.糊涂窗口综合征：由于**交互式进程每次读取的数据小**，而导致接收方窗口设置较小导致的传输效率低下。
​		解决方法：让**接收方等待一段时间**，当自己的**空余缓存足够**容纳一个最长报文段，或者等到接收缓存已有一半空闲的空间。

## TCP的拥塞控制

#### 拥塞控制的一般原理

​	**拥塞**：网络中**某一资源的需求超过了该资源所能提供的可用部分**。
​	拥塞控制：防止**过多的数据注入到网络**中，这样可以**使网络中的路由器或链路不至于过载**。
​	**区别于流量控制**：拥塞控制讨论的是**网络中的堵塞问题**即网络内部的拥塞，流量控制讨论的是**在网络通畅情况下**，接**收方的接收能力问题**。
​	主要的两类控制方法：**开环控制**和**闭环控制**
​	**开环控制**：就是在**设计网络时实现将发生拥塞的有关因素考虑周到**，力求网络在工作时不产生拥塞。
​	**闭环控制**：1.监测网络系统以便检测到拥塞在何时、何处发生。2.把拥塞发生的信息传送到可采取行动的地方。3.调整网络系统的运行以解决出现的问题。

#### TCP的拥塞控制方法

​	TCP进行拥塞控制的算法：**慢开始**、**拥塞避免**、**快重传**、**快恢复**。

​	下面讨论的时**基于窗口**的拥塞控制。发送方维持一个叫做拥塞窗口cwnd的状态变量，拥塞窗口的大小取决于网络的拥塞程度，时动态变化的。发送方让**自己的发送窗口等于拥塞窗口**。
​	1.**慢开始和拥塞避免**
​		慢开始算法**思路是：由小到大逐渐增大注入到网络中的数据字节 ，，由小到大逐渐增大拥塞窗口数值。在没收到一个**对新的报文段的确认**后，可以把拥塞窗口增加多一个SMSS的数值。 
​		拥塞窗口cwnd每次增加了 = min(N, SMSS)，我们用**报文段的个数**作为窗口大小的单位。**N是原先未被确认地，但现在刚被收到的确认报文段所确认地字节数。**

​		**拥塞避免算法**：为了**让拥塞窗口cwnd缓慢地增大**，采用**加法增大**法。往往当拥塞窗口≥慢开始门限ssthresh时候使用。
​		当遇到超时时，则**设置ssthresh = cwnd / 12**，**cwnd = 0**，**并且重新进行慢开始算法**。
​	2.**快重传和快恢复**
​	**快重传算法**：可以让**发送方尽早知道发生了个别报文地丢失**。其首先要求接收方不要等待自己发送数据时才捎带确认，而是要**立即发送确认**，即使收到了**失序的报文段**，也要立即发出对已收到的报文段的重复确认。

​	**快恢复算法**：当发送方知道自己现在只是丢失了个别的报文段。于是不启动慢开始，而是执行快恢复算法。这时调整门限值，**ssthresh = cwnd / 2**， **cwnd = ssthresh**；并且在每次收到确认后，**cwnd = ssthresh + 3 * MSS**(使得快速恢复到某个合理值的边缘)。
​	在拥塞避免阶段，采用线性增大即**加法增大AI**，一旦出现**超时**或**3个重复确认**，就把门限值降低到当前拥塞窗口值的以阿布那，并大大减小拥塞窗口的值即"**乘法减小**"**MD**。合称为**AIMD算法**。
​	接收方窗口又称为通知窗口。发送方的**发送窗口一定不能超过对方给出的接收方窗口值cwnd**。
​	**发送方窗口的上限值 = Min(接收方窗口rwnd，拥塞窗口cwnd)**

#### 主动队列管理AQM

​	网络层的策略**对TCP拥塞控制影响最大**的就是路由器的**分组丢弃策略**。最简单情况下通常都按照”**先进先出**“**FIFO**的规则处理到来的分组。当队列已满时，采用**尾部丢弃策略**。

​	为了避免发生网络中的全局同步现象，在1998年提出了而**主动队列管理AQM**：在队列长度达到某个值的警惕的数值时，就主动丢弃到达的分组。
​	AQM早期流行的实现方法有**随机早期检测RED**。
​		1.小于最小门限时直接入队。 2.大于最大门限时全部丢弃 3.大于最小门限小于最大门限时全部丢弃。

## TCP的运输连接管理

#### TCP的连接建立(三次握手)

![TCP的连接建立](E:\MarkDown_study\计算机网络\img\TCP的连接建立.png)

​	1.A的TCP客户进程创建**传输控制块TCB**，发送连接请求报文，**SYN = 1**， **初始序号seq = x**。
​	2.B收到连接请求报文后，向A发送确认报文，**ACK = 1**，**SYN = 1**, **seq  = y**, **ack = x + 1**。
​	3.A收到B的确认后，还要向B发出确认报文。**ACK = 1**，**seq = x + 1**，**ack = y + 1**。

#### TCP的连接释放(四次握手)

![TCP的连接释放](E:\MarkDown_study\计算机网络\img\TCP的连接释放.png)

​	1.A发出连接释放报文，**FIN = 1**，**seq = u**，A进入**终止等待1**。
​	2.B收到连接释放，发出确认报文，**ACK = 1**，**seq = v**，**ack = u + 1**。 
​	3.A收到B的确认后，就进入**终止等待2**，**等待B发出的连接释放报文段**
​	4.B没有要发送的数据了，B向A发送连接释放报文，**FIN = 1**， **ACK = 1**， **seq  = w**，**ack = u + 1**，进入最后确认状态。
​	5.A收到报文后发送确认报文，**ACK = 1**，**seq = u + 1**，**ack = w + 1**，进入时间等待计时器在**2MSL最大报文段寿命**后进入CLOSED状态。
​	6.B收到确认报文后，进入**CLOSED状态**。

#### TCP的有限状态机

![TCP的有限状态机](E:\MarkDown_study\计算机网络\img\TCP的有限状态机.png)