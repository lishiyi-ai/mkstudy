## 概述

#### BIgTable

​	特性：支持大规模海量数据，分布式并发数据处理效率极高，易于扩展且支持动态伸缩，适用于廉价设备，适合读操作不适合写操作。

#### ==简介==

​	HBase利用==Hadoop MapReduce==来处理HBase中的海量数据，实现==高性能计算==；
​	利用==ZooKeeper==作为==协同服务==，实现 稳定服务 和 失败恢复；
​	使用==HDFS==作为高可靠的底层存储，利用链接集群==提供海量数据存储能力==；
​	==Sqoop==为HBase提供了高效、便捷的==关系数据库管理系统==。

#### ==HBase与传统关系数据库的对比分析== 七个

​	**数据类型**：把数据存储为未经解释的字符串，用户需要自己编写程序把字符串解析成不同数据类型。
​	**数据操作**：HBase只提供了简单的插入、查询、删除、清空等，**无法实现**像关系数据库种那样的**表与表之间的连接操作**。
​	**存储模式**：HBase是基于列存储的，每个列由几个文件保存，不同列族的文件是分离的。优点是：降低IO开销，支持大量并发用户查询；同一列族种的数据会被一起压缩。
​	**数据索引**：HBase中的所有访问方法，或通过**行键访问**，或通过**行键扫描**。
​	**数据维护**：HBase更新，并不会删除数据的旧的版本，而是生成一个新的版本。
​	**可伸缩性**：HBase可以**灵活实现横向扩展**。
​	**HBase不支持事务，无法实现跨行的原子性**。

## HBase访问接口

​	Native Java API 适合MapReduce左行并行
​	HBase SHell 适合HBase管理
​	Thrift Gateway 支持其他异构系统在线访问
​	REST Gateway 支持REST风格
​	Pig 数据通信
​	Hive 类似于SQL方式

## HBase数据模型

HBase是一个稀疏、多维度、排序的映射表，这张表的索引包括行键，列族，列限定符和时间戳。
HBase提供了两种数据版本回收方式：一是保存数据的最后n个版本；二是保存最近一段时间内的版本。

#### 数据模型的相关概念

​	表：采用表来组织数据，表有行和列组成，列划分为若干个列族。
​	行键：每个HBase表都由若干行组成，每个行由行键来表示。
​	列族：一个HBase表被分组成许多“列族”的集合，他是基本的访问控制单元。
​	列限定符：列族里的数据通过列限定符来定位。
​	单元格：在HBase表中，通过行键，列族和列限定符来确定一个单元格。
​	时间戳：每个单元格都保存着同一份数据的多个版本，这些版本采用时间戳进行索引。

#### 数据坐标

​	["行键", "列族", "列限定符", "时间戳"]

#### 面向列的存储

​	列式数据库采用列式存储模型，其对关系进行垂直分解， 并未每个属性分配一个子关系。

## HBase的实现原理

#### HBase的功能组件

​	**库函数**，链接到每个客户端；
​	一个**Master主服务器**；负责管理和维护HBase表的分区信息。
​	许多个**Region服务器**；负责存储和维护分配给自己的Region。
​	HBase客户端并不依赖于Master而是借助于ZooKeeper来获得Region的位置信息。

#### 表 和 Region

​	表中包含的行的数量可能非常庞大，无法存储在一台机器上，需要分布式存储到多台机器上。因此许多对行进行分区。每个**行区间**构成一个分区被称为**"Region"**

#### ==Region的定位==

​	每一个Region都有一个RegionID来表示他的唯一性，这样一个Region标识符就可以表示成：**"表名 + 开始主键 + RegionID"。**
​	==HBase使用类似于B+树的三层结构来保存Region位置信息：==

​	

|  层次  |     名称      |                             作用                             |
| :----: | :-----------: | :----------------------------------------------------------: |
| 第一层 | ZooKeeper文件 |                     记录了-ROOT-表的信息                     |
| 第二层 |   -ROOT-表    | 记录了.META.表的Region位置信息==，-ROOT-表只能有一个Region==。 |
| 第三层 |   .META.表    | 记录了用户数据表Region位置信息，.META.表可以有多个Region，保存了HBase种所有用户数据表的Region位置嘻嘻你。 |

#### HBase中的分区是如何定位的？

​	通过构建的映射表的每个条目包含两项内容，**一个是Region 的 标识符**，**另一个是Region服务器标识**，这个条目就标识Region和Region服务器之间的对应关系，从而就可以知道某个Region被保存在哪个Region服务器中。

## HBase运行机制

#### HBase系统架构

​	客户端：用来加快后续数据访问过程。
​	ZooKeeper服务器：有多台机器构成的集群来提供稳定可靠的协同服务。
​	Master主服务器：负责表和Region的管理工作
​	Region服务器：负责维护分配给自己的Region，并响应用户的读写请求。

#### ==Region服务器的工作原理==

​	1.**==用户读写数据的过程==**，用户数据首先被写入MemStore 和 HLog中，当操作写入HLog之后，commit()调用才会将其返回客户端。Region服务器会==首先访问MemStore缓存==，如果不存在才会到磁盘上面的StoreFile中寻找。

​	2.**==缓存的刷新==**，系统**周期性地调用Region.flushcache()**将**MEMStore的内容写入到磁盘文件StoreFile文件**中，清空缓存，并且在**HLog文件中写入一个标记**，表示缓存中的内容已经被写入StoreFile文件中。每**次缓存刷新操作都会在磁盘上生成一个新的StoreFile文件**，所以**每个Store包含多个StoreFile文件**。
​	3.**==StoreFIle的合并==**， 系统一般调用**Store.compact()将多个StoreFile文件合并为一个大文件**。由于合并操作耗费资源，通常**只会在StoreFile文件的数量达到一个阈值时才触发合并操作**。

#### ==Store的工作原理==

​	**每个Store对应了表中的一个列族的存储。每个Store包括一个==MemStore==缓存和若干个==StoreFile==文件**。MenStore是排序的内存缓冲区，当用户写入数据时，系统**首先把数据放入MenStore缓存**，当MemStore缓存满时，就会刷新到磁盘中的一个StoreFile文件中**。随着StoreFile文件数量的不断增加，当达到事先设定的阈值是触发文件合并操作，当单个StoreFile文件大小超过一定阈值时，就会触发文件分裂操作**。

#### ==HLog的工作原理==

​	HBase系统为**每个Region服务器配置了一个HLog文件**，它是一种**预写式日志**（Write Ahead Log），用户更新数据必须**首先写入日志**后，才能写入MemStore缓存，并且，直到MemStore缓存内容**对应的日志已经写入磁盘**，该缓存内容才能被刷写到磁盘。

#### ==当一台Region服务器意外终止时，Master如何发现这种意外终止情况？为了恢复这台发生意外的Region服务器上的Region,Master应该做出哪些处理(包括如何使用HLog进行恢复)?==

​	**Zookeeper会实时监测每个Region服务器的状态******，当某个Region服务器发生故障时，**Zookeeper会通知Master**。

Master**首先会处理该故障Region服务器上面遗留的HLog文件**，这个遗留的HLog文件中包含了来自多个Region对象的日志记录。

系统会根据每条日志记录所属的**Region对象对HLog数据进行拆分，分别放到相应Region对象的目录下**，然后，再将**失效的Region重新分配到可用的Region服务器中**，**并把与该Region对象相关的HLog日志记录也发送给相应的Region服务器**。

​    Region服务器领取到分配给自己的Region对象以及与之相关的HLog日志记录以后，**会重新做一遍日志记录中的各种操作，把日志记录中的数据写入到MemStore缓存中，然后，刷新到磁盘的StoreFile文件中，完成数据恢复**。



#### ==在HBase中，每个Region服务器维护一个HLog，而不是为每个Region都单独维护一个HLog。请说明这种做法的优缺点。==

优点： 多个Region对象的更新操作所发生的日志修改，只需要不断把日志记录追加到单个日志文件中，不需要同时打开、写入到多个日志文件中，可以减少磁盘寻址次数，提高对表的写操作性能。

缺点：如果一个Region服务器发生故障，为了恢复其上的Region对象，需要将Region服务器上的HLog按照其所属的Region对象进行拆分，然后分发到其他Region服务器上执行恢复操作。

#### ==请举个实例来阐述HBase的概念视图和物理视图的不同。==

在HBase的概念视图中，**一个表可以视为一个稀疏、多维的映射关系**。在物理视图中，**一个表会按照属于同一列族的数据保存在一起**。