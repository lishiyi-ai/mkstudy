## 单例模式的创建

使用局部静态变量懒汉模式创建连接池。

~~~C++
class connection_pool{
public:
	//局部静态变量单例模式
	static connection_pool *GetInstance();
private:
    connection_pool();
    ~connection_pool();
}
connection_pool *connection_pool::GetInstance(){
    static connection_pool connPool;
    return &connPool;
}
~~~

## 连接池代码实现

连接池的定义中注释比较详细，这里仅对其实现进行解析。

连接池的功能主要有：初始化，获取连接、释放连接，销毁连接池。

#### **初始化**

值得注意的是，销毁连接池没有直接被外部调用，而是通过RAII机制来完成自动释放；使用信号量实现多线程争夺连接的同步机制，这里将信号量初始化为数据库的连接总数。

#### **获取、释放连接**

当线程数量大于数据库连接数量时，使用信号量进行同步，每次取出连接，信号量原子减1，释放连接原子加1，若连接池内没有连接了，则阻塞等待。

另外，由于多线程操作连接池，会造成竞争，这里使用互斥锁完成同步，具体的同步机制均使用lock.h中封装好的类。

#### **销毁连接池**

通过迭代器遍历连接池链表，关闭对应数据库连接，清空链表并重置空闲连接和现有连接数量。

## RAII机制释放数据库连接

#### **定义**

这里需要注意的是，在获取连接时，通过有参构造对传入的参数进行修改。其中数据库连接本身是指针类型，所以参数需要通过双指针才能对其进行修改。

#### **实现**

不直接调用获取和释放连接的接口，将其封装起来，通过RAII机制进行获取和释放。