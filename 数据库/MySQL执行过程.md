## MySQL 执行流程是怎样的？

![mysql执行过程](E:\MarkDown_study\数据库\img\mysql执行过程.png)

执行顺序：from，on，join，where，group by，avg，sum，having，select，distinct，order by，limit。

Mysql的架构分为两层，Server层和存储引擎层

**Server层负责建立连接，分析和执行SQL**。MySQL大多数的核心功能都在这实现，主要包括**连接器，查询存储，解析器，预处理器，优化器、执行器**等。

**存储引擎层负责数据的存储和提取**。支持InnoDB、MylSAM、Memory等多个存储引擎。

#### 连接器

MySQ是**基于TCP协议进行传输**的。
MySQL**定义了空闲连接的最大空闲时长**，由**wait_timeout**参数控制，默认为8小时。
MySQL服务支持的**最大连接数由max_connections**参数控制。

**MySQL由短连接和长连接**：
	长连接可以减少建立俩姐和断开连接的过程。但使用**长连接后可能会占用内存增多**，因为MySQL在执行查询过程中临时使用内存管理连接对象，这些**连接对象资源只有在连接断开时才会释放**。长连接累计过多，会导致MySQL服务占用内存太大，导致MysQL服务异常重启的现象。
	**解决方法**：
		①定期断开长连接。②客户端主动重置连接。

#### 查询缓存

对于查询语句，会将结果存入查询缓存，如果以后有一样的查询则直接从查询缓存(key-value保存)中返回。

在MySQL8.0版本后直接将查询缓存删掉了。

#### 解析器

第一件事情，词法分析。第二件是语法分析

#### 预处理器

prepare 阶段，也就是预处理阶段；
检查 SQL 查询语句中的**表或者字段是否存在**；
 `select *` 中的 **`*` 符号，扩展为表上的所有列**；

#### 优化器

optimize 阶段，也就是优化阶段；
优化器主要**负责将SQL查询语句的执行方案确定下来**，优化器会基于查询成本的考虑，来**决定选择使用哪个索引**。
可以使用**explain**来查看使用了哪个索引。

#### 执行器

execute 阶段，也就是执行阶段；
执行器和存储引擎的交互过程：
	**①主键索引查询。**
		调用**read_firts_record**让存储引擎定位符合条件的第一条记录。read_record指向-1，因此访问直接结束查询。
	**②全表扫描。**
		调用**read_firts_record**让存储引擎定位符合条件的第一条记录。因为查询为all，因此使用read_record继续查询，直到遍历全表。
	**③索引下推。**
		存储引擎定位到二级索引后，先不执行回标操作，而是先判断一下该索引中包含的列的条件是否成。不成立则跳过，成立则徽标。