## 虚拟存储器概述

有的作用很大，有大量作业要求运行，但由于内存容量不够大，物理上增加内存容量，但受限制，无疑要增加系统成本。而**逻辑上扩充内存容量**，这正是**虚拟存储技术索要解决的主要问题**。

#### 常规存储 管理方式的特征和局部性原理

==**1.常规存储管理方式的特征**==
	①一次性：作业必须一次性地全部装入内存后方能开始运行。
	②驻留性：作业被装入内存后，整个作业都一直驻留在内存中，其中任何部分都不会被换出，直至作业运行结束。

==**2.局部性原理**==
	①程序执行时，除了少部分地转移和过程调用指令外，在大多数情况下是**顺序执行**的。
	②过程调用将会使程序的执行轨迹由一部分区域转至另一部份区域。**程序会在一段时间内，都局限在这些过程地范围内运行**。
	③**程序中存在许多循环结构**，这些结构虽然只由少数指令构成，但执行次数多。
	④程序中还包括许多对数据结构的处理，往往都局限于很小范围。

==局限性有表现在两个方面：==
	①**时间局限性：**如果程序中的某条指令被执行，则不久以后该指令**可能再次执行**。某个数据被访问，可能不久后该数据可能**再次被访问** 。
	②**空间局限性：**一旦程序访问了某个存储单元，在不久之后，其附近地存储单元也可能被访问，即**程序在一段时间所访问地地址可能集中在一定范围之内的**。

**3.虚拟存储器的基本工作情况**
	基于局部性原理可知，应用**程序在运行之前没必要将之全部装入内存**，而**仅须将那些当前运行的少数页面或段先装入内存便可运行**。         程序在运行时，若所访问页面**已调入内存，便可继续执行**；否则产生**缺页中断**，将请求页面调入内存，如果内存已满则**利用页(段)置换功能**。

#### 虚拟存储器的定义和特征

**1.定义**
所谓虚拟存储器，是指具有请求调入功能和置换功能，能从逻辑上对内存容量加以扩充的一种存储器系统。
其逻辑容量由内存容量和外村容量之和所决定，其运行速度接近于内存速度，而每位的成本却接近于外存。

**==2.特征==**
	**多次性：**相对一次性，指一个作业中的程序和数据无需在作业运行时一次性地全部装入内存，而是**允许被分成多次调入内存运行**，即**只需要将当前运行地那部分程序和数据装入内存即可开始运行**。
	**对换性：**相对常驻性而言，指一个作业中的程序和数据，无须在作业运行时一直常驻内存，而是**允许在作业的允许过程中进行换进、换出**。
	**虚拟性：**虚拟性是指能够从**逻辑上扩充内存容量**，使用户所看到的内存容量远大于实际内存容量。

#### 虚拟存储器的实现方法

**1.分页请求系统**
	在分页系统的基础上增加了**请求调页功能**和页面置换功能所形成的**页式虚拟存储系统**。
**==硬件支持：==**
	①请求分页的页表机制②缺页中断机构③地址变换机构
**实现请求分页的软件：**
	用于实现**请求调页**的软件和**实现页置换**的软件。

**2.请求分段系统**
	在分段系统的基础上，增加了**请求调段**及**分段置换功能**后所形成的**段式虚拟存储系统**。
**==硬件支持：==**
	①请求分段的段表机制②缺段中断机构③地址变换机构
**软件支持：**
	用于实现**请求调段**的软件和**实现段置换**的软件。

## ==请求分页存储管理方式==

#### 请求分页中的硬件支持

**1.请求页表机制**

| 页号 | 物理块号 | 状态位(存在位)P | 访问字段A | 修改位M | 外存地址 |
| :--: | :------: | :-------------: | :-------: | :-----: | :------: |

**2.缺页中断机构**(与一般的中断的区别)
	在**指令执行期间**产生和处理中断信号。
	一条指令在执行期间可能**产生多次缺页中断**。

**3.地址变换机构**
	在分页系统中的地址变换机构基础上，增加了一些功能，如产生和处理缺页中断。

#### 请求分页的内存分配

为进程分配内存时，**涉及到的问题**：
	①为保证进程能正常运行，所需要的最小物理块数②在位每个进程分配物理块时，应采取什么样的分配策略(固定，还是可变)
	③分配的物理块数是按照平均分配算法，还是进程的大小比例分配。
**1.最小物理块数的确定**
	最小物理块数是指能保证进程正常运行所需的最小物理块数，直接寻址 2块，间接寻址 3块。根据具体情况具体设计。

**2.内存分配策略**
	①**固定分配局部置换**
	②**可变分配全局置换**(**从所有进程的全部物理块中选择一块**)
	③**可变分配局部置换**(**只允许从该进程在内存的页面中选择一页换出**)

**3.物理块分配算法**
	①**平均分配算法**
	②**按比例分配算法**
	③**考虑优先权分配算法。**

#### 页面调入策略

**1.何时调入所需页面**
	①**预调页策略：**如果进程的许多页是存放在外村的一个连续区域中，**一次性调入若干个相邻的页**。
	②**请求调页策略：**在**运行时**，若**发现其所在的页面不在内存**，便立即**提出请求**，由**OS将其所需页面调入内存**。

**2.何处调入这些页面**
	①系统拥有足够的对换区空间。
	②系统缺少足够的对换区空间。
	③UNIX方式。

**3.如何进行调入。**
	当要访问的页面未存在内存时(存在位0)，便向CPU发生一缺页中断，进行页面置换，若置换出的页面(修改为1)，则必须写回磁盘。并修改页表中的相应表项，置其存在位为“1”，并写入快表。

**4.缺页率**
	f = F/A，F为失败次数，A为总访问次数。****
**影响缺页率的因素：4个**
	①页面大小②进程所分配的物理块数目③页面置换算法④程序固有特性。
	缺页中断处理时间的计算公式：**t = β * ta + (1 - β) * tb**

## ==页面置换算法==

#### 最佳置换算法和先进先出置换算法

**1.最佳置换算法**
	选择的被淘汰页面将是**以后用不使用的**，或是在**最长时间内不再被访问的一面**。

**2.先进先出置换法**
	选择在内存中**驻留时间最久的页面予以淘汰**。

#### 最近最久未使用和**最少使用置换算法**

**1.LRU(最近最久未使用)**
	选择**最近最久未使用**的页面予以淘汰。
	**硬件支持：**① 寄存器②栈

**2.LFU(最少使用)**
	选择在**最近时期使用最少**的页面作为淘汰页。

#### Clock置换算法

**1.简单的Clock置换算法**
	为每页设置一位访问位，再将内存中的所有页面都通过链接指针连接成一个循环队列。**当某页被访问时，访问位被置1**。置换算法在选择一个页面淘汰时**，若访问位为0，则置换出去，若为1则置为0**。按照FIFO算法检查下一个页面。

**2.改进型Clock置换算法**
	在**改进型Clock算法**中，还需考虑**置换代价**。因此将**页面分为四类依照访问和修改**。按照从维修到已修改的顺序进行**淘汰**。	

#### 页面缓冲算法

**1.影响页面换进换出效率的若干因素**
	①页面置换算法。是系统
	②写回磁盘的频率。
	③读入内存的频率。

**2.页面缓冲算法PBA**
主要特点：①**显著地降低了页面换进、换出的效率**，使磁盘I/O的操作次数大为减少。②由于换入换出的开销大小的大幅度减小，才能使其**采用一种较简单的置换策略**。
**①空闲页链表：**
	实际上该链表是一个空闲物理块链表，是**系统掌握的空闲物理块**，用于**分配给频繁发生缺页的进程**，以**降低该进程的缺页率**。

**②修改页面链表：**
	由**已修改的页面所形成的链表**。 设置该链表的目的是为了减少已修改页面换出的次数。

#### ==访问内存的有效时间==

**①访问在快表中：**EAT = λ + T
**②访问在内存中；**EAT = λ + T + λ + T
**③访问不在内存中：**EAT = λ + a * t + (1 - a) * (t + f*(Σ+e + λ) + (1 - f) * (λ + t))

## “抖动”与工作集

#### 多道程序度和“抖动”

**1.多道程序度与处理机的利用率**
	虚拟存储系统能从逻辑上扩大内存，随着多道程序的数量增加，利用率先上升后下降。这是因为系统发生了抖动。
==**2.抖动产生的原因**==
	同时在系统中运行的进程太多，**由此分配给每一个进程的物理块太少**，**不能满足进程正常运行的基本要求**，致使每个进程在运行时，频繁地出现缺页，必须请求系统将所缺之页调入内存。
	**抖动：**每个进程频繁地发生页面的换入/换出。

#### 工作集

**1.工作集地基本概念**
	程序在运行期间，对页面的访问是不均匀的，在一段时间内仅局限与较少的页面， 在另一段时间内，有可能仅局限于对另一些较少的页面进行访问。这些页面成为**活跃页面**。

**2.工作集的定义**
	所谓的工作集：在某时间间隔里，进程实际**所要访问页面的集合**。某个进程在时间t的工作集记为w(t, Δ)，其中Δ称为工作集的“窗口尺寸”。

#### ==“抖动”的预防方法==

**1.采取局部置换策略**
	可以将抖动，限制在较小的范围内，但会导致**延长了其它进程对磁盘的访问时间**。

**2.把工作集算法融入到处理机调度中**
	当调度程序发现处理机利用率低下时，它将试图从外村调入一个新作业进入内存，来改善处理机的利用率。

**3.利用“L= S”准则调节缺页率**
	L是缺页之间的平均时间，S是平均缺页服务时间。

**4.选择暂停的进程**
	当多道程序度偏高时，已影响到处理机的利用率，为了防止发生抖动，系统必须减少多道程序数目。

## ==请求分段存储管理方式==

#### 请求分段中的硬件支持

**1.请求段表机制**

| 段名 | 段长 | 段基址 | 存取方式 | 访问字段A | 修改位M | 存在位P | 增补位 | 外存始址 |
| :--: | :--: | :----: | :------: | :-------: | :-----: | :-----: | :----: | :------: |

**2.缺段中断机构**
	在请求分段系统中采用的是**请求调段策略**。每当发现运行进程所要访问的**段尚未调入内存时**，便由缺段中断机构产生一缺段中断信号，进入OS后，**有缺段中断处理程序将所需的段调入内存**。

**3.地址变换机构**
	请求分段系统中的地址变换机构是在分段系统地址变换机构的基础上形成的。当段不在内存中时，则开始缺页中断处理。

#### 分段的共享和保护

**1.共享段表**
	**①共享进程计数count：**共享段是为多个进程所需要的，为记录有多少进程正在共享分段，须设置共享进程计数，只有当count为0时才回收该段。
	**②存取控制字段：**对于一个共享段，应为不同的进程赋予不同的存取权限。
	**③段号：**对于一个共享段，在不同进程中可以具有不同的段号，每个进程可以用自己进程的段号访问该共享段。

**2.共线段的分配与回收**
	**①共享段的分配：**在共享段分配内存时，对第一个请求使用该共享段的进程，由系统为**该共享段分配一物理区**，再把该**共享段调入该区**，**同时将该区的始址填入请求进程的段表的相应项**中，还须**在共享段表中增加一段表**。**填写请求使用该共享段的进程名，段号和存取控制等有关数据，把count置为1。**
	**②共享段的回收：**当共享此段的某进程不需要该段时，应将该段释放，包括**撤销在该进程段表中共享段所对应的项**，以及执行count--，**若count为0则回收**，并**取消在共享段段表中该段所对应的表项**。否则只**取消调用者进程在共享段表中的相关记录**。

**3.分段保护**

​	**①越界检查：**由地址变换机构完成。若大于段长，产生地址越界中断信号。
​	**②存取控制检查：**
​		只读、只执行、读/写
​	**③环保护机构：**
​		低编号的环具有高优先权。**OS核心处于0号环内**；
​		某些重要的**实用程序和操作系统服务占居中间环**；
​		**一般程序安排在外环**。
​	规则：一个程序可以访问驻留在**相同环或较低权环**的**数据**。
​		   一个程序可以调用驻留在**相同环或较高全环**的**服务**。

