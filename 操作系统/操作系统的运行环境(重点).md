## 处理器运行模式

CPU执行两种不同性质的程序：一种是操作系统**内核程序**；另一种是用户**自编程序**。

**特权指令：**不允许用户直接使用的指令，如I/O指令，关中断指令，内存清零指令，存取用于内存保护的寄存器，送PSW与程序状态字寄存器等的指令。

**非特权指令：**是只允许用户直接使用的指令，它不能直接访问系统中的软硬件资源，仅限于访问用户的地址空间，这也是为了防止用户程序对系统造成破坏。

#### 内核的4各方面

**1.时钟管理**

**2.中断机制**
	中断机制中，只有一小部分功能属于内核，他们负责保护和恢复中断现场地信息，转移控制权到相关的处理程序。

​	**用户态切换到内核态，是硬件实现。保存断点 和 程序状态字，也是硬件实现。**

**3.原语**
**特点：**
	①处于操作系统底层，最接近硬件部分
	②具有原子性
	③运行时间短，而且调用频繁
	定义原语的直接方法是**关中断**，让其所有**动作不可分割地完成后再打开中断**。

**4.系统控制的数据结构及处理**
	进程管理，存储器管理，设备管理。

## 中断和异常的概念

**中断：**也称外中断，是指来自CPU执行指令外部的事件，通常用于信息输入/输出，**I/O结束中断**。**时钟中断**。

**异常：**也称内中断，是指来自CPU执行指令内部的事件，如**非法操作码，地址越界，运算溢出，虚存系统的却也，陷入指令**。**异常不能屏蔽**。

**分类：**
	**外中断**分为 **可屏蔽中断(INTR)** 和 **不可屏蔽中断(NMI)**。
	**异常**分为**故障，自陷和终止**。故障、自陷属于**软中断**；终止异常 和 外部中断属于**硬中断**。

==**处理过程：**==
**发出一个中断请求信号**，CPU**打断当前的用户程序**，然后**转到相应的中断或异常处理程序去执行**。
若中断或异常处理程序能够解决相应的问题，则在**中断或异常处理程序后**，CPU通过**执行中断或异常返回指令**，返回现场。
若发现不可恢复的致命错误，则**终止用户程序**。

==**中断处理和子程序调用的比较：**==
	①中断处理程序与被中断的按当前程序是**相互独立的**，子程序与主程序是同一程序的两个部分，属于**主从关系**。
	②中断**产生**是随机的，子程序调用是通过调用指令(CALL)引起的。
	③调用子程序的**过程**完全属于软件处理过程；中断处理的过程需要有专门的硬件电路才能实现。
	④中断处理程序的**入口地址**可由硬件向量法产生向量地址；子程序的入口地址是由CALL指令的地址码给出。
	⑤中断处理和子程序都需要保护程序计数器(PC)的内容，==前者有中断隐指令(保存PC，PSW)，后者由CALL指令完成(只保存PC，不保存PSW)==
	⑥相应中断时，需要**多个中断请求进程裁决**；调用子程序时没有这个操作。

## 系统调用

系统调用按功能大致分为如下几类：
	设备管理，文件管理，进程控制，进程通信，内存管理。
==**系统调用的处理过程**==

第一步：用户程序首先将系统调用号和所需的参数压入堆栈，然后调用，**执行陷入指令**，将用户态转到和心态，再有硬件和操作系统内核程序保护被中断进程的线程，包括PC，PSW，寄存器。
第二步：分析系统调用类型：转入相应的系统调用处理子程序。根据系统调用号可以找到该系统调用处理子程序的入口(采用数组)。
第三步：在系统调用处理子程序执行结束后，**恢复被中断的或设置新进程的CPU现场**，然后返回被中断进程或新进程，继续执行。