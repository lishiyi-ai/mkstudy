## 外存的组织方式

三种：
①连续组织方式。②链接组织方式。③索引组织方式。

#### 连续组织方式

在采用连续组织方式时，可把逻辑文件中的记录顺序地存储到邻接的各物理盘块中，这样所形成的文件结构称为顺序文件结构，物理文件称为顺序文件。
**主要优点**：
	1.顺序访问容易。
	2.顺序访问速度快。
**主要缺点**：
	1.要求位文件**分配连续地存储空间**。
	2.必须**事先知道**文件的**长度**。
	3.**不能灵活**地删除和插入记录。
	4.对于**动态增长**的文件，很**难分配**空间。

#### 链接组织方式

**主要优点**：
	1.**消除**了磁盘的**外部碎片**，提高了外存的利用率。
	2.对**插入、删除和修改**记录都非常容易。
	3.能**适应**文件的**动态增长**，无需事先知道文件的大小。

**1.隐式链接**
	文件目录的每个**目录项**中，都须含有指向链接文件**第一个盘块**和**最后一个盘块的指针**。**每个盘块含有**一个**指向下一个盘块的指针**。

**2.显式链接**
	把用于链接文件各物理块的指针显示地**存放在内存的一张链接表**中，该表在整个磁盘中仅设置一张。

#### FAT技术

**1.FAT12**(12位)
	①早期的FAT12文件系统：
		以**盘块为基本分配单位**。为了安全起见，每个分区中都配有**两张相同的文件分配表**FAT1和FAT2；
	②以簇为单位的FAT12文件系统：
		簇是一组相邻的扇区，在FAT中它是作为一个虚拟扇区。在进行盘块分配时，是以簇作为分配的基本单位。

**2.FAT16**
	由FAT12位增至16位，扩大了最大表项数。

**3.FAT32**
	继续增加FAT表的宽度，达到32位，允许管理比FAT更多的簇，允许采用较小的簇。

#### NFTS的文件组织方式

1.**新的特征**：
	使用64位磁盘地址；
	很好地支持长文件名，单个文件名限制在255个字符以内，全路径名为32767字符
	具有系统容错功能；
	能保证系统中的数据一致性；
	NTFS还提供了文件加密、文件压缩等功能。

2.**磁盘组织**：
	NTFS是以簇作为磁盘空间分配和回收的基本单位，簇默认大小为4KB，NTFS采用**逻辑簇号LCN**来对簇定位。

3.**文件组织**：
	在NTFS中，以卷为单位，将一个卷中的所有文件信息，目录信息以及可用的未分配空间信息，都以文件记录的方式在一张主控文件表MFT。
	主控文件表，为每个文件做一条记录，在MTF表中占有一行，其中还包括MFT自己这一行。每行固定大小1KB，称为元数据。

#### 索引组织方式

1.**单机索引组织方式**

连接组织方式存在的**问题**：
	①不能支持高效的直接存取，要对一个较大的文件进行存取，须在FAT中顺序地查找许多盘块号。
	②FAT需占用较大的内存空间，由于一个文件所占用盘块的盘块号是随机地分布在FAT中，因此要整个FAT调入内存。

索引分配法为每个文件配备一个索引块，把分配给该文件地所有盘块号都记录在该索引块中，在建立文件时，只须在为之建立的**目录表**中填上指向**该索引块地指针**。
**主要优点**：
	支持直接访问；也不会产生外部碎片。

**主要问题**：
	每建立一个索引文件时，应为该文件分配一个索引块。一个索引块可存放数百盘块号。对于小文件可能只有数十盘块，因此效率极低。

2.**多级索引组织方式**
	当文件太大，其索引块太多时，单级索引的效率降低(退化到链接方式)。此时可以建立多级索引。通过一级一级索引进行访问。从而解决了所引块太多退化的问题。

3.**增量式索引组织方式**
	①增量式索引组织方式的基本思想
		对于小型文件，直接放入文件块控制块，直接寻址。
		对于中间文件，采用单级索引组织方式，一次间接寻址。
		对于大型文件。采用多级索引组织方式，多次间接寻址。
	②UNIX System V的组织方式
		直接地址：在索引结点设置10个直接地址项，用i.addr(0) 到 i.addr(9)来存放直接地址。
		一次间接地址：利用i.addr(10)来提供一次间接地址。
		多次间接地址：利用i.addr(n > 9)来提供多次间接寻址。

## 文件存储空间的管理

为了管理可分配存储空间设置相应的数据结构，即设置一个**磁盘分配表**，用于记住可供分配的存储空间情况。

#### 空闲表法 和 空闲链表法

1.**空闲表法**
	空闲表法属于连续分配方式，为每个文件分配一块连续的存储空间。
	空闲盘区的分配与内存的分区(动态)分配类似，采用首次适应算法和最佳适应算法等。

2.**空闲链表法**
将所有空闲盘曲拉成一条空闲链。链表分成两种形式：**空闲盘块链**  和 **空闲盘区链**。
	①空闲盘块链
		将磁盘上的所有空闲空间以盘块为单位拉成一条链，其中的每一盘块都指向后继盘块指针。
	②空闲盘区链
		这是将磁盘上所有空闲盘区拉成一条链。每个盘曲上除含用于指示下一个空闲盘区的指针外，还应有能指明本盘曲大小的信息。

#### 位示图法

1.**位示图**
	利用二进制的一位来表示磁盘中一个盘块的使用情况。

2.**盘块的分配**
	①顺序扫描位示图。②将所找到的一组二进制转换成与之相应的盘块号。③修改位示图。

3.**盘块的回收**
	①将盘块号转换成位示图的行号和列号。②修改位示图。

#### 成组链接法

1.**空闲盘块的组织**
	①空闲盘块号栈，存放当前可用的一组空闲盘块的盘块号，以及空闲盘块数。
	②文件区中的所有空闲盘块被分成若干组。
	③将每一组的盘块总数N和该组所有的盘块号记录其前一组的第一个盘块的S.free(0)到.free(99)中。
	④将第一组的盘块总数和所有的盘块号记录空闲盘块号栈中，作为当前可供分配的空闲盘块号。
	⑤最末一组只有99个可用盘块，其盘块号分别记入前一组的S.free(1)到S.free(99)中，而在S.free(0)则存放"0"。

2.**空闲盘块的分配与回收**
	将空闲盘块栈中的盘块分出去，当分配到最后一个时，将其存储的下一组可用盘号存入栈中并加该盘块分配出去。
	然后再分配一相应的缓冲区，最后把栈中空闲盘块数减1并返回。

## 提高磁盘I/O速度的途径

①**改进文件的目录结构以及检索目录的方法**来减少对目录的查找时间。
②选取好的**文件存储结构**，以及**提高对文件的访问速度**。
③**提高磁盘的I/O速度**，能将文件中的数据快速地从磁盘传送到内存中，或这相反。

#### 磁盘高速缓存

设计磁盘高速缓存时需要考虑的问题有：
	①如何将磁盘告诉缓存中的数据传送给请求进程。
	②采用什么样的置换策略。
	③已修改的盘块数据在何时被写回磁盘。

**1.数据交付方式**
	**数据交付**：直接将高速缓存中的数据传送到请求者进程的内存工作区中。
	**指针交付**：只将指向高速缓存中某区域的指针交付给请求者进程。

**2.置换算法**
常用的算法是LRU，NRU，LFU等。现在不少系统设计其高速缓存的置换算法时，还考虑以下几点：
	①访问频率②可预见性③数据的一致性。

**3.周期性地写回磁盘**

#### 提高磁盘I/O速度的其他方法

①提前读②延迟写③优化物理块的分布④虚拟盘

#### 廉价磁盘冗余阵列(RAID)

**1.并行交叉存取**
	在存放一个文件时，可将该文件中的第一个数据子块放在第一个磁盘上；将文件的第二个数据子块放在第二个磁盘上；以此类推。从而达到并行存储。

**2.RAID的分级**
	**RAID 0级**：仅提供**并行交换存取**。
	**RAID 1级**：具有磁盘镜像功能。采用一半磁盘作为**镜像盘**
	**RAID 3级**：具有并行传输功能的磁盘阵列。只利用一台**奇偶效验盘**来完成数据的校验功能。
	**RAID 5级**：具有独立传送功能的磁盘阵列。**每个驱动器都各有自己独立的数据通路**，独立地进行读/写，且无专门校验盘。
	**RAID 6级** 和 **RAID 7级**：RAID6级阵列中，设置一个专用的、可快速访问的**异步校验磁盘**。RAID7级时对RAID6级的改进。

**3.RAID的优点**

​	①可靠性高②磁盘I/O速度高③性能/价格比高

## 提高磁盘可靠性的技术

#### 第一级容错技术SFT-1

**1.双份目录和双份文件分配表**

**2.热修复重定向和==写后读校验==**
	热修复重定向：系统将磁盘容量很小的一部分作为热修复重定向区，用于存放发现磁盘有缺陷时的待写数据。
	写后读校验：每次向磁盘中写入数据块后，又立即将它读出，送至另一缓冲区，再将其与内存缓冲区进行比较。

#### 第二级容错技术SFT-2

**1.磁盘镜像**
	在同一磁盘控制器下，再增加一个完全相同的磁盘驱动器。

**2.磁盘双工**
	将两台磁盘驱动器分别接到两个磁盘控制器上，同样使这两台磁盘机镜像成对。

#### 基于集群技术的容错功能

**1.双机热备份模式**
	这种模式下北邮两台服务器，两者的处理能力通常是完全相同的个，一台作为主机服务器，另一台作为备份服务器。两台服务器上各装入一块网卡，并通过一条镜像服务器链路MSL将两台服务器连接起来。
	**优点**：提高了系统的可用性，易于实现，且主、备份服务器完全独立，可支持远程热备份。
	**缺点**：从服务器处于被动等待状态，效率只有百分之50

**2.双机互为备份模式**
	平时，两台服务器均为在线服务器，它们各自完成自己的任务。两者利用单模光纤来连接。每台服务器都配备两台硬盘。一个用于装载系统程序和应用程序，一个用于接收由另一台服务器发来的备份数据，作为该服务器的镜像盘。

**3.公用磁盘模式**
	为了减少信息复制的开销，可以将多台计算机连接到一台公共的磁盘系统上。公共磁盘被划分为多个卷，每台计算机使用一个卷。

#### 后备系统

**1.磁带机**
	最早的计算机系统的外存储器。只适合存储顺序文件。

**2.硬盘**
	①移动磁盘②固定硬盘驱动器

**3.光盘驱动器**
	①只读光盘CD-ROM 和 DVD-ROM

## 数据一致性控制

#### 事务

**1.事物的定义**
事务是用于访问和修改各种数据项的一个程序单位。

事务的四种属性：①原子性A②一致性C③隔离性I④持久性D 

**2.事务记录**
为实现上述的原子修改， 通常须借助称为事务记录的数据结构来实现

~~~c++
事务名: 用于表示该事务的唯一名字。
数据项名: 它时被修改数据项的唯一名字。
旧值: 修改前数据项的值。
新值: 修改后数据项具有的值。
~~~

**3.恢复算法**

**①undo** 该过程把所有被事务修改过的数据恢复到修改前的值。

**②redo** 该过程把所有被事务修改过的数据设置会新值。

#### 检查点

**1.检查点的作用**
对事物记录表中事务记录的清理工作经常化，每隔一定时间便做一次下述工作：
	①将内存中的事务记录表中所有记录输出到外存中。
	②将内存中所有已修改的数据输出到外存中。
	③将事务记录表中的检查点记录输出外存中。
	④每出现一个检查点记录时，便执行恢复操作 。

**2.新的恢复算法**
只需要对最后一个检查点之后的事务记录进行处理。
对所有在T中的事务Tk，如果在事务记录表中出现了Tk托付记录，则执行redo操作，反置则执行undo操作。

#### 并发控制

**1.利用互斥锁实现“顺序性”。**

**2.利用互斥锁和共享锁实现顺序性。**

#### 重复数据地数据一致性问题

**1.重复文件的一致性**
**第一种方法**：
	当一个文件被修改后可查找文件目录，以得到其它一个拷贝的索引结点号，再从这些索引结点中找到各拷贝的物理位置，然后对这些拷贝做同样的修改。
**第二种方法**：
	为新修改的文件建立几个拷贝，并用新拷贝去取代原来的文件拷贝。

**2.链接数一致性检查**
共享文件的索引结点中有一个**链接计数count**和索引节点号在**目录的次数**的一致性。
**方法**：
	需要配置一张计数器表，此时应当为每个文件建立一个表项，其中含有该索引结点号的计数值。
